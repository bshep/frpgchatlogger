name: Deploy to AWS EC2

on:
  push:
    branches:
      - main # Trigger this workflow on pushes to the 'main' branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18' # Use a Node.js version compatible with your frontend

    - name: Install Frontend Dependencies
      run: |
        cd frontend
        npm install

    - name: Build Frontend
      run: |
        cd frontend
        npm run build

    - name: Deploy to EC2
      env:
        SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
      run: |
        # Ensure SSH key has correct permissions
        echo "$SSH_PRIVATE_KEY" > deploy_key.pem
        chmod 600 deploy_key.pem

        # Define target directory on EC2
        DEPLOY_DIR="/var/www/frpgchatlogger/"

        ssh -o StrictHostKeyChecking=no -i deploy_key.pem $EC2_USER@$EC2_HOST "ls -l $DEPLOY_DIR" || mkdir -p $DEPLOY_DIR

        # Transfer backend files
        # Note: If backend contains sensitive files (like .env), adjust scp to exclude them.
        scp -o StrictHostKeyChecking=no -i deploy_key.pem -r backend $EC2_USER@$EC2_HOST:$DEPLOY_DIR/

        # Transfer analysis files
        scp -o StrictHostKeyChecking=no -i deploy_key.pem -r analysis $EC2_USER@$EC2_HOST:$DEPLOY_DIR/

        # Transfer frontend build output
        # Ensure 'dist' matches your actual frontend build output directory.
        scp -o StrictHostKeyChecking=no -i deploy_key.pem -r frontend/dist/* $EC2_USER@$EC2_HOST:$DEPLOY_DIR/html/

        # Transfer the backup script to a temporary location
        scp -o StrictHostKeyChecking=no -i deploy_key.pem scripts/backup_db.sh $EC2_USER@$EC2_HOST:/tmp/backup_db.sh

        # SSH into EC2 to move scripts, run backup, deploy, and verify
        ssh -o StrictHostKeyChecking=no -i deploy_key.pem $EC2_USER@$EC2_HOST "
          set -e
          echo 'Setting up scripts...'
          sudo mv /tmp/backup_db.sh /usr/local/bin/backup_db.sh
          sudo chmod +x /usr/local/bin/backup_db.sh

          echo 'Running pre-deployment backup...'
          # Run backup script, but don't fail deployment if it errors (e.g., DB doesn't exist yet)
          /usr/local/bin/backup_db.sh || echo 'Backup script failed, continuing deployment.'

          echo 'Navigating to project root...'
          cd /var/www/frpgchatlogger/

          echo 'Updating backend dependencies...'
          python3 -m venv backend/venv_backend
          source backend/venv_backend/bin/activate
          pip install -r backend/requirements.txt
          deactivate

          echo 'Restarting services...'
          sudo systemctl daemon-reload
          sudo systemctl restart frpgchatlogger_backend.service
          sudo systemctl restart frpgchatlogger_scheduler.service
          sudo systemctl restart nginx
          
          echo 'Verifying cron job...'
          if [ -f /etc/cron.d/frpgchatlogger-backup ]; then
              echo 'Cron job file found. Contents:'
              sudo cat /etc/cron.d/frpgchatlogger-backup
          else
              echo 'Creating cron job file...'
              echo '# Run database backup every 12 hours at midnight and noon
              0 0,12 * * * ec2-user /usr/local/bin/backup_db.sh >> /var/log/cron.log 2>&1
              ' > /tmp/frpgchatlogger-backup
              sudo mv /tmp/frpgchatlogger-backup /etc/cron.d/frpgchatlogger-backup
              sudo chmod 644 /etc/cron.d/frpgchatlogger-backup
              echo 'Cron job file created.'
          fi

          echo 'Deployment successful!'
        "
